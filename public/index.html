
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genera Piano Alimentare - Dieta AI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-leaf"></i>
        <a href="/dashboard.html">Dieta AI</a>
      </div>
      <nav>
        <ul>
          <li><a href="/dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
          <li><a href="/calendar.html"><i class="fas fa-calendar-alt"></i> Calendario</a></li>
        </ul>
      </nav>
      <div class="user-info">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <button id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Esci</button>
      </div>
    </div>
  </header>

  <div class="container">
    <main>
      <section class="section">
        <h2 class="section-title">Crea il Tuo Piano Alimentare Personalizzato</h2>
        <p>Compila il questionario per generare un piano alimentare personalizzato in base alle tue esigenze.</p>
        
        <form id="questionnaireForm" class="questionnaire-form">
          <div class="form-grid">
            <div class="form-group">
              <label for="age">Età</label>
              <input type="number" id="age" class="form-control" required min="18" max="100">
            </div>
            
            <div class="form-group">
              <label for="weight">Peso (kg)</label>
              <input type="number" id="weight" class="form-control" required min="40" max="200" step="0.1">
            </div>
            
            <div class="form-group">
              <label for="height">Altezza (cm)</label>
              <input type="number" id="height" class="form-control" required min="140" max="220">
            </div>
            
            <div class="form-group">
              <label for="gender">Genere</label>
              <select id="gender" class="form-control" required>
                <option value="">Seleziona</option>
                <option value="male">Uomo</option>
                <option value="female">Donna</option>
                <option value="other">Altro</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="goals">Obiettivo</label>
            <select id="goals" class="form-control" required>
              <option value="">Seleziona il tuo obiettivo</option>
              <option value="lose_weight">Perdere peso</option>
              <option value="maintain_weight">Mantenere il peso</option>
              <option value="gain_muscle">Aumentare massa muscolare</option>
              <option value="improve_health">Migliorare la salute generale</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="activity">Livello di Attività Fisica</label>
            <select id="activity" class="form-control" required>
              <option value="">Seleziona</option>
              <option value="sedentary">Sedentario (poco o nessun esercizio)</option>
              <option value="light">Leggero (esercizio 1-3 volte/settimana)</option>
              <option value="moderate">Moderato (esercizio 3-5 volte/settimana)</option>
              <option value="active">Attivo (esercizio 6-7 volte/settimana)</option>
              <option value="very_active">Molto attivo (esercizio intenso, lavoro fisico)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Allergie o Intolleranze</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="allergy_gluten" name="allergies" value="gluten">
                <label for="allergy_gluten">Glutine</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="allergy_lactose" name="allergies" value="lactose">
                <label for="allergy_lactose">Lattosio</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="allergy_nuts" name="allergies" value="nuts">
                <label for="allergy_nuts">Frutta a guscio</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="allergy_shellfish" name="allergies" value="shellfish">
                <label for="allergy_shellfish">Crostacei</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="allergy_eggs" name="allergies" value="eggs">
                <label for="allergy_eggs">Uova</label>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label>Preferenze Alimentari</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="preference_vegetarian" name="preferences" value="vegetarian">
                <label for="preference_vegetarian">Vegetariano</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="preference_vegan" name="preferences" value="vegan">
                <label for="preference_vegan">Vegano</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="preference_pescatarian" name="preferences" value="pescatarian">
                <label for="preference_pescatarian">Pescetariano</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="preference_keto" name="preferences" value="keto">
                <label for="preference_keto">Keto</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="preference_lowcarb" name="preferences" value="lowcarb">
                <label for="preference_lowcarb">Low Carb</label>
              </div>
            </div>
          </div>
          
          <button type="submit" class="button"><i class="fas fa-magic"></i> Genera Piano Alimentare</button>
        </form>
      </section>
      
      <div id="loadingSection" class="section" style="display:none; text-align:center;">
        <h2 class="section-title">Creazione Piano Alimentare in Corso</h2>
        <p>Stiamo generando il tuo piano alimentare personalizzato. Questo processo può richiedere alcuni secondi.</p>
        <div class="loading-animation">
          <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--primary-color); margin: 30px 0;"></i>
        </div>
      </div>
    </main>
  </div>

  <script src="/js/app.js"></script>
  <script>
    // Gestione del form del questionario
    document.getElementById('questionnaireForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Nascondi il form e mostra il caricamento
      this.style.display = 'none';
      document.getElementById('loadingSection').style.display = 'block';
      
      // Raccogli i dati del form
      const userData = {
        age: parseInt(document.getElementById('age').value),
        weight: parseFloat(document.getElementById('weight').value),
        height: parseInt(document.getElementById('height').value),
        gender: document.getElementById('gender').value,
        goals: document.getElementById('goals').value,
        activity: document.getElementById('activity').value,
        allergies: Array.from(document.querySelectorAll('input[name="allergies"]:checked')).map(el => el.value),
        preferences: Array.from(document.querySelectorAll('input[name="preferences"]:checked')).map(el => el.value)
      };
      
      try {
        const token = localStorage.getItem('accessToken');
        if (!token) {
          throw new Error('Utente non autenticato');
        }
        
        const response = await fetch('/api/submit-questionnaire', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ userData })
        });
        
        if (!response.ok) {
          throw new Error('Errore nella generazione del piano alimentare');
        }
        
        const result = await response.json();
        
        // Salva il piano alimentare nel localStorage
        localStorage.setItem('mealPlan', JSON.stringify(result.mealPlan));
        
        // Segnala che stiamo generando un nuovo piano
        localStorage.removeItem('generatingNewPlan');
        
        // Reindirizza alla dashboard
        window.location.href = '/dashboard.html';
      } catch (error) {
        console.error('Errore:', error);
        alert('Si è verificato un errore durante la generazione del piano alimentare. Riprova più tardi.');
        
        // Mostra nuovamente il form e nascondi il caricamento
        document.getElementById('questionnaireForm').style.display = 'block';
        document.getElementById('loadingSection').style.display = 'none';
      }
    });
  </script>
</body>
</html>
